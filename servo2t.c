/* This SG90 Servo Motor is capable of 180º from end to end.
 * Motor was found to have following points:
 * 90º CC - 2.320ms
 * 0º     - 1.355ms
 * 90º CW - 0.613ms */

#include <avr/io.h>
#include <avr/interrupt.h>

#define COUNTSTART 2

uint8_t msCountDown = COUNTSTART;
volatile uint8_t timerFlag;
uint8_t stage = 0;

uint16_t table[] = 
{
    1968, 1986, 2005, 2023, 2041, 2059, 2077, 2095, 2113, 2131,
    2149, 2167, 2184, 2202, 2219, 2236, 2253, 2270, 2286, 2303,
    2319, 2335, 2351, 2366, 2832, 2397, 2411, 2426, 2440, 2454,
    2468, 2481, 2494, 2507, 2519, 2531, 2543, 2555, 2566, 2576,
    2587, 2596, 2606, 2615, 2624, 2632, 2640, 2648, 2655, 2662,
    2668, 2674, 2679, 2684, 2689, 2693, 2687, 2700, 2703, 2705,
    2707, 2708, 2709, 2710, 2710, 2710, 2709, 2708, 2706, 2704,
    2701, 2698, 2695, 2691, 2686, 2682, 2676, 2671, 2665, 2658,
    2651, 2644, 2636, 2628, 2620, 2611, 2601, 2592, 2581, 2571,
    2560, 2549, 2537, 2525, 2513, 2501, 2488, 2475, 2461, 2447,
    2433, 2419, 2404, 2389, 2374, 2359, 2343, 2327, 2311, 2295,
    2278, 2261, 2245, 2227, 2210, 2193, 2175, 2158, 2140, 2122,
    2104, 2086, 2068, 2050, 2032, 2014, 1995, 1977, 1959, 1941,
    1922, 1904, 1886, 1868, 1850, 1832, 1814, 1796, 1778, 1761,
    1743, 1726, 1709, 1691, 1675, 1658, 1641, 1625, 1609, 1593,
    1577, 1562, 1547, 1532, 1517, 1503, 1489, 1475, 1461, 1448,
    1435, 1423, 1411, 1399, 1387, 1376, 1365, 1355, 1344, 1335,
    1325, 1316, 1308, 1300, 1292, 1285, 1278, 1271, 1265, 1260,
    1254, 1250, 1245, 1241, 1238, 1235, 1232, 1230, 1228, 1227,
    1226, 1226, 1226, 1227, 1228, 1229, 1231, 1233, 1236, 1239,
    1243, 1247, 1252, 1257, 1262, 1268, 1274, 1281, 1288, 1296,
    1304, 1312, 1321, 1330, 1340, 1349, 1360, 1370, 1381, 1393,
    1405, 1417, 1429, 1442, 1455, 1468, 1482, 1496, 1510, 1525,
    1539, 1554, 1570, 1585, 1601, 1617, 1633, 1650, 1666, 1683,
    1700, 1717, 1734, 1752, 1769, 1787, 1805, 1823, 1841, 1859,
    1877, 1895, 1913, 1931, 1950, 1968
};

ISR(TIMER0_COMPA_vect)
{
    timerFlag = 1;
}


int main(void)
{
    // Setup Timer 0 for timing changes to Servo position
    TCCR0A |= 1<<WGM01; 
    TCCR0B |= 1<<CS02 | 1<<CS00;
    OCR0A  = 124;
    TIMSK0 |= 1<<OCIE0A;

    // Setup Timer 1 for the Servo PWM source
    // Servo takes 20ms periods of 1ms to 2ms pulses
    // 1ms = 0º
    // 2ms = 90º
    DDRB |= 0xFF;
    TCCR1A |= 1<<WGM11 | 1<<COM1A1;
    TCCR1B |= 1<<WGM12 | 1<<WGM13 | 1<<CS11;
    
    ICR1 = 39999;
    OCR1A = 2999;

    sei();

    while(1)
    {
       if(timerFlag == 1)
       {
           timerFlag = 0;
           if (--msCountDown == 0)
           {
               msCountDown = COUNTSTART;
               OCR1A = table[stage];
               stage++;
           }
       } 
    }
}
